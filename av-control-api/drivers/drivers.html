<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Drivers :: BYU OIT AV // Docs</title>
    <link rel="canonical" href="https://docs.av.byu.edu/av-control-api/drivers/drivers.html">
    <meta name="generator" content="Antora 2.1.2">
    <link rel="stylesheet" href="../../_/css/site.css">
<link rel="stylesheet" href="../../_/css/site-extra.css">
<link rel="stylesheet" href="../../_/css/vendor/docsearch.min.css">
<!-- fetched from https://cdn.jsdelivr.net/npm/docsearch.js@2/dist/cdn/docsearch.min.css -->
<link rel="icon" href="../../_/img/favicon.ico" type="image/x-icon">
  </head>
  <body class="article">
<header class="header" role="banner">
  <nav class="navbar">
    <div class="navbar-brand">
      <div class="navbar-item">
        <a href="https://it.byu.edu">BYU OIT AV</a>
        <span class="separator">//</span>
        <a href="https://docs.av.byu.edu">Docs</a>
      </div>
      <button class="navbar-burger" data-target="topbar-nav">
        <span></span>
        <span></span>
        <span></span>
      </button>
    </div>
    <div id="topbar-nav" class="navbar-menu">
      <div class="navbar-end">
        <div class="navbar-item has-dropdown is-hoverable">
          <div class="navbar-link">Projects</div>
          <div class="navbar-dropdown">
            <div class="navbar-item"><strong>AV Control API</strong></div>
            <a class="navbar-item" href="https://github.com/byuoitav/av-control-api">Repository</a>
            <a class="navbar-item" href="https://github.com/byuoitav/av-control-api/issues">Issue Tracker</a>
            <hr class="navbar-divider">
            <a class="navbar-item" href="https://gitlab.com/antora/antora/blob/master/contributing.adoc">Contributing</a>
          </div>
        </div>
        <div class="navbar-item has-dropdown is-hoverable">
          <div class="navbar-link">Tools</div>
          <div class="navbar-dropdown is-right">
            <a class="navbar-item" href="https://smee.avs.byu.edu">BYU Monitoring</a>
          </div>
        </div>
        <a class="navbar-item" href="https://github.com/byuoitav">
          <span class="icon">
            <svg aria-hidden="true" data-icon="github" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512">
              <path fill="#57aaee" d="M459.37 151.716c.325 4.548.325 9.097.325 13.645 0 138.72-105.583 298.558-298.558 298.558-59.452 0-114.68-17.219-161.137-47.106 8.447.974 16.568 1.299 25.34 1.299 49.055 0 94.213-16.568 130.274-44.832-46.132-.975-84.792-31.188-98.112-72.772 6.498.974 12.995 1.624 19.818 1.624 9.421 0 18.843-1.3 27.614-3.573-48.081-9.747-84.143-51.98-84.143-102.985v-1.299c13.969 7.797 30.214 12.67 47.431 13.319-28.264-18.843-46.781-51.005-46.781-87.391 0-19.492 5.197-37.36 14.294-52.954 51.655 63.675 129.3 105.258 216.365 109.807-1.624-7.797-2.599-15.918-2.599-24.04 0-57.828 46.782-104.934 104.934-104.934 30.213 0 57.502 12.67 76.67 33.137 23.715-4.548 46.456-13.32 66.599-25.34-7.798 24.366-24.366 44.833-46.132 57.827 21.117-2.273 41.584-8.122 60.426-16.243-14.292 20.791-32.161 39.308-52.628 54.253z"></path>
            </svg>
          </span>
        </a>
      </div>
    </div>
  </nav>
</header>
<div class="body">
<div class="nav-container" data-component="av-control-api" data-version="master">
  <aside class="nav">
    <div class="panels">
<div class="nav-panel-menu is-active" data-panel="menu">
  <nav class="nav-menu">
    <h3 class="title"><a href="../index.html">AV Control API</a></h3>
<ul class="nav-list">
  <li class="nav-item" data-depth="0">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="../quickstart/quickstart.html">Quick Start</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../quickstart/hardwareSetup.html">Hardware Set Up</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../quickstart/OS.html">Setting Up the Operating System</a>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="../quickstart/DB.html">Database</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../quickstart/devices.html">devices table</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../quickstart/device_types.html">device_types table</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../quickstart/rooms.html">rooms table</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../quickstart/buildings.html">buildings table</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../quickstart/room_configurations.html">room_configurations table</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../quickstart/DemoDBScript.html">Demo Couch Documents</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../quickstart/roles.html">Device Roles</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="../quickstart/startAPI.html">Deploying Docker Containers</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../quickstart/API.html">Using the AV API</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../quickstart/APIBody.html">API Body &amp; Response</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../quickstart/UI.html">Using the UI</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../quickstart/byuArchitecture.html">Exploring BYU&#8217;s Implementation</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../quickstart/FAQ.html">Frequently Asked Questions</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item is-current-page" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="drivers.html">Drivers</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#_writing_a_driver">Writing a Driver</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#_creating_a_driver_server">Creating a Driver Server</a>
  </li>
</ul>
  </li>
</ul>
  </li>
</ul>
  </nav>
</div>
<div class="nav-panel-explore" data-panel="explore">
  <div class="context">
    <span class="title">AV Control API</span>
    <span class="version">master</span>
  </div>
  <ul class="components">
    <li class="component is-current">
      <span class="title">AV Control API</span>
      <ul class="versions">
        <li class="version is-current is-latest">
          <a href="../index.html">master</a>
        </li>
      </ul>
    </li>
    <li class="component">
      <span class="title">Hardware</span>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../../hardware/index.html">master</a>
        </li>
      </ul>
    </li>
    <li class="component">
      <span class="title">Lazarette</span>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../../lazarette/index.html">master</a>
        </li>
      </ul>
    </li>
  </ul>
</div>
    </div>
  </aside>
</div>
<main>
<div class="toolbar" role="navigation">
<button class="nav-toggle"></button>
  <a href="../index.html" class="home-link"></a>
<nav class="breadcrumbs" aria-label="breadcrumbs">
  <ul>
    <li><a href="../index.html">AV Control API</a></li>
    <li><a href="drivers.html">Drivers</a></li>
  </ul>
</nav>
  <div class="edit-this-page"><a href="https://github.com/byuoitav/av-control-api/edit/master/docs/modules/drivers/pages/drivers.adoc">Edit this Page</a></div>
  </div>
<article class="doc">
<h1 class="page">Drivers</h1>
<div id="preamble">
<div class="sectionbody">
<div class="paragraph">
<p>Drivers are the services that the av-api calls to talk to physical AV devices.
We write/use <a href="https://github.com/byuoitav/nec-driver">libraries</a> that implement one of the interfaces in this package - which interface they implement depends on the type of device the driver is written for.</p>
</div>
<div class="paragraph">
<p>Subdirectories of this package are all of our BYU-specific driver servers, which are compiled into docker containers based on the <a href="nec/dockerfile"><code>dockerfile</code></a> (and the <a href="nec/dockerfile-arm"><code>dockerfile-arm</code></a> for arm containers).</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_writing_a_driver"><a class="anchor" href="#_writing_a_driver"></a>Writing a Driver</h2>
<div class="sectionbody">
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Create a new repo, titled with the control protocol or vendor <code>-driver</code>.</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>Use the github provided Go <code>.gitignore</code>.</p>
</li>
<li>
<p>Repos from BYU OIT AV should use the <a href="https://www.apache.org/licenses/LICENSE-2.0">Apache 2.0 License</a></p>
</li>
</ol>
</div>
</li>
<li>
<p>Clone your repo by running <code>git clone <a href="mailto:git@github.com">git@github.com</a>:&lt;org/repo&gt;.git</code></p>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
All new repos should use go mod. Make sure to clone your repo outside of your <code>$GOPATH</code>.
</td>
</tr>
</table>
</div>
</li>
<li>
<p>Initialize <a href="https://blog.golang.org/using-go-modules">go mod</a> by running <code>go mod init &lt;github.com/org/repo&gt;</code> in your newly cloned repo.</p>
</li>
<li>
<p>In a new file, create a struct in your new package that will implement the appropriate interface. Its fields should have data required to use the driver.</p>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Each instantiation of your struct should semantically represent a specific device (IE a single projector) and as such should contain <em>all</em> of the information required to control that device
</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-go hljs" data-lang="go">package adcp <i class="conum" data-value="1"></i><b>(1)</b>

type Projector struct {
	Address  string <i class="conum" data-value="2"></i><b>(2)</b>
	Username string <i class="conum" data-value="2"></i><b>(2)</b>
	Password string <i class="conum" data-value="2"></i><b>(2)</b>
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>A driver library should typically have only one package</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Not required, just an example</td>
</tr>
</table>
</div>
</li>
<li>
<p>Implement all of the required functions in the matching interface found in this package. For example, to make a projector driver, you would probably want to implement the interface found in <a href="display.go"><code>display.go</code></a>.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-go hljs" data-lang="go">func (p *Projector) GetPower(ctx context.Context) (string, error) { <i class="conum" data-value="1"></i><b>(1)</b>
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Confused with context? These articles are a great place to start: <a href="https://blog.golang.org/context">1</a>, <a href="https://dave.cheney.net/2017/08/20/context-isnt-for-cancellation">2</a>, <a href="https://dave.cheney.net/2017/01/26/context-is-for-cancelation">3</a></td>
</tr>
</table>
</div>
<div class="admonitionblock caution">
<table>
<tr>
<td class="icon">
<i class="fa icon-caution" title="Caution"></i>
</td>
<td class="content">
Make sure that your driver library has good test code to ensure future changes don&#8217;t break things. 😊
</td>
</tr>
</table>
</div>
</li>
<li>
<p>Once a working version of your library is ready, release a v1.0.0 version of it. For future releases, use <a href="https://semver.org/">semantic versioning</a> to denote changes.</p>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Err on the side of caution here. It&#8217;s ok to stay at V0.X for a while as things stabilize. Once you go V1, things will have to follow semantic far more strictly.
</td>
</tr>
</table>
</div>
</li>
</ol>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">$ git tag -a "v1.0.0"
$ git push --tags</code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_creating_a_driver_server"><a class="anchor" href="#_creating_a_driver_server"></a>Creating a Driver Server</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Once you have finished a library, or want to use one that implements one of the driver interfaces, you create create a driver server.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Create a subdirectory in this one with the name of your driver server. Usually, this should match the driver name, without the <code>-driver</code> suffix.</p>
</li>
<li>
<p>In your new directory, initalize go mod by running <code>go mod init github.com/byuoitav/drivers/&lt;folder name&gt;</code></p>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
In this case, go mod is used to reliably import the correct version of external libraries, and not for exporting your package.
</td>
</tr>
</table>
</div>
</li>
<li>
<p>Add the dockerfiles for both linux and arm to the directory</p>
</li>
<li>
<p>TODO anything else <a href="https://github.com/bwinterton" class="bare">https://github.com/bwinterton</a> needs to build these (makefiles, etc.)</p>
</li>
<li>
<p>Create a <code>server.go</code> file. This is where all of your driver server&#8217;s code should go.</p>
<div class="admonitionblock caution">
<table>
<tr>
<td class="icon">
<i class="fa icon-caution" title="Caution"></i>
</td>
<td class="content">
This will be changing shortly to represent new decisions. (TODO)
</td>
</tr>
</table>
</div>
</li>
</ol>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-go hljs" data-lang="go">package main <i class="conum" data-value="1"></i><b>(1)</b>

// imports

func main() { <i class="conum" data-value="1"></i><b>(1)</b>
    var port int
    // variable declarations

    pflag.IntVarP(&amp;port, "port", "p", 80, "port to run the server on") <i class="conum" data-value="2"></i><b>(2)</b>
    // other flags

    pflag.Parse() <i class="conum" data-value="3"></i><b>(3)</b>

    // create a net.Listener to run the server on
    addr := fmt.Sprintf(":%d", port)
    lis, err := net.Listen("tcp", addr)
    if err != nil {
        // handle err
    }

    // import driver library
    display := &amp;adcp.Projector{} <i class="conum" data-value="4"></i><b>(4)</b>

    // create server
    server := drivers.CreateDisplayServer(display) <i class="conum" data-value="5"></i><b>(5)</b>
    if err = server.Serve(lis); err != nil {
        // handle err
    }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Must be in package <code>main</code> with a <code>main()</code> function. This is where your driver server will start.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>The port to run our servers will be passed in as part of the dockerfile.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>We use the <a href="https://github.com/spf13/pflag">pflag</a> library for POSIX style flags.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>The variable, package, and struct name will change depending on the driver you are importing.</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>Use the correct <code>Create&#8230;&#8203;Server()</code> function for the interface your driver implements.</td>
</tr>
</table>
</div>
</div>
</div>
</article>
</main>
</div>
<footer class="footer">
  <p>Copyright (C) 2019-2020 <a href="https://byu.edu">Brigham Young University</a>.</p>
  <p>Except where otherwise noted, docs.av.byu.edu are licensed under the <a href="https://www.mozilla.org/en-US/MPL/2.0/">Apache Version 2.0</a></p>
</footer>
<script src="../../_/js/site.js"></script>
<script async src="../../_/js/vendor/highlight.js"></script>
  </body>
</html>
