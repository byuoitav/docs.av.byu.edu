<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Take a Pi Image :: BYU OIT AV // Docs</title>
    <link rel="canonical" href="https://docs.av.byu.edu/hardware/pi-image.html">
    <meta name="generator" content="Antora 2.1.2">
    <link rel="stylesheet" href="../_/css/site.css">
<link rel="stylesheet" href="../_/css/site-extra.css">
<link rel="stylesheet" href="../_/css/vendor/docsearch.min.css">
<!-- fetched from https://cdn.jsdelivr.net/npm/docsearch.js@2/dist/cdn/docsearch.min.css -->
<link rel="icon" href="../_/img/favicon.ico" type="image/x-icon">
  </head>
  <body class="article">
<header class="header" role="banner">
  <nav class="navbar">
    <div class="navbar-brand">
      <div class="navbar-item">
        <a href="https://it.byu.edu">BYU OIT AV</a>
        <span class="separator">//</span>
        <a href="https://docs.av.byu.edu">Docs</a>
      </div>
      <button class="navbar-burger" data-target="topbar-nav">
        <span></span>
        <span></span>
        <span></span>
      </button>
    </div>
    <div id="topbar-nav" class="navbar-menu">
      <div class="navbar-end">
        <div class="navbar-item has-dropdown is-hoverable">
          <div class="navbar-link">Projects</div>
          <div class="navbar-dropdown">
            <div class="navbar-item"><strong>AV Control API</strong></div>
            <a class="navbar-item" href="https://github.com/byuoitav/av-control-api">Repository</a>
            <a class="navbar-item" href="https://github.com/byuoitav/av-control-api/issues">Issue Tracker</a>
            <hr class="navbar-divider">
            <a class="navbar-item" href="https://gitlab.com/antora/antora/blob/master/contributing.adoc">Contributing</a>
          </div>
        </div>
        <div class="navbar-item has-dropdown is-hoverable">
          <div class="navbar-link">Tools</div>
          <div class="navbar-dropdown is-right">
            <a class="navbar-item" href="https://smee.avs.byu.edu">BYU Monitoring</a>
          </div>
        </div>
        <a class="navbar-item" href="https://github.com/byuoitav">
          <span class="icon">
            <svg aria-hidden="true" data-icon="github" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512">
              <path fill="#57aaee" d="M459.37 151.716c.325 4.548.325 9.097.325 13.645 0 138.72-105.583 298.558-298.558 298.558-59.452 0-114.68-17.219-161.137-47.106 8.447.974 16.568 1.299 25.34 1.299 49.055 0 94.213-16.568 130.274-44.832-46.132-.975-84.792-31.188-98.112-72.772 6.498.974 12.995 1.624 19.818 1.624 9.421 0 18.843-1.3 27.614-3.573-48.081-9.747-84.143-51.98-84.143-102.985v-1.299c13.969 7.797 30.214 12.67 47.431 13.319-28.264-18.843-46.781-51.005-46.781-87.391 0-19.492 5.197-37.36 14.294-52.954 51.655 63.675 129.3 105.258 216.365 109.807-1.624-7.797-2.599-15.918-2.599-24.04 0-57.828 46.782-104.934 104.934-104.934 30.213 0 57.502 12.67 76.67 33.137 23.715-4.548 46.456-13.32 66.599-25.34-7.798 24.366-24.366 44.833-46.132 57.827 21.117-2.273 41.584-8.122 60.426-16.243-14.292 20.791-32.161 39.308-52.628 54.253z"></path>
            </svg>
          </span>
        </a>
      </div>
    </div>
  </nav>
</header>
<div class="body">
<div class="nav-container" data-component="hardware" data-version="master">
  <aside class="nav">
    <div class="panels">
<div class="nav-panel-menu is-active" data-panel="menu">
  <nav class="nav-menu">
    <h3 class="title"><a href="index.html">Hardware</a></h3>
<ul class="nav-list">
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item is-current-page" data-depth="1">
    <a class="nav-link" href="pi-image.html">Take a Pi Image</a>
  </li>
</ul>
  </li>
</ul>
  </nav>
</div>
<div class="nav-panel-explore" data-panel="explore">
  <div class="context">
    <span class="title">Hardware</span>
    <span class="version">master</span>
  </div>
  <ul class="components">
    <li class="component">
      <span class="title">AV Control API</span>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../av-control-api/index.html">master</a>
        </li>
      </ul>
    </li>
    <li class="component is-current">
      <span class="title">Hardware</span>
      <ul class="versions">
        <li class="version is-current is-latest">
          <a href="index.html">master</a>
        </li>
      </ul>
    </li>
    <li class="component">
      <span class="title">Lazarette</span>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../lazarette/index.html">master</a>
        </li>
      </ul>
    </li>
  </ul>
</div>
    </div>
  </aside>
</div>
<main>
<div class="toolbar" role="navigation">
<button class="nav-toggle"></button>
  <a href="../av-control-api/index.html" class="home-link"></a>
<nav class="breadcrumbs" aria-label="breadcrumbs">
  <ul>
    <li><a href="index.html">Hardware</a></li>
    <li><a href="pi-image.html">Take a Pi Image</a></li>
  </ul>
</nav>
  <div class="edit-this-page"><a href="https://github.com/byuoitav/hardware/edit/master/modules/ROOT/pages/pi-image.adoc">Edit this Page</a></div>
  </div>
<article class="doc">
<h1 class="page">Take a Pi Image</h1>
<div id="preamble">
<div class="sectionbody">
<div class="paragraph">
<p>We update our Pi image every 4-6 months to keep install times speedy. As part of an install, we update the Pi to make sure it has all the latest security patches, and the longer it&#8217;s been since we updated the image, the longer that update takes. The following is the process we follow to take an image.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_getting_started"><a class="anchor" href="#_getting_started"></a>Getting started</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Download the lastest <strong>lite</strong> Raspbian image from <a href="https://www.raspberrypi.org/downloads/raspbian">the Raspberry Pi Foundation</a> and flash it onto an SD card. Before inserting the SD card into a Pi, it&#8217;s helpful to create a file called <code>ssh</code> in the <code>boot</code> partition so that you can SSH into the Pi once it&#8217;s plugged in. Once that&#8217;s done, insert the SD card into the Pi, plug in a network cable, and insert the power cable to turn the Pi on.</p>
</div>
<div class="paragraph">
<p>Once the Pi is powered on, you&#8217;ll be able to SSH into the Pi using the IP address that is printed a few lines above the login line. The default username is <code>pi</code> and the default password is <code>raspberry</code>.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_os_setup"><a class="anchor" href="#_os_setup"></a>OS Setup</h2>
<div class="sectionbody">
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
Most of these commmands require being root to run them. It&#8217;s easiest to just become the root user by running <code>sudo su</code> when you start a new section.
</td>
</tr>
</table>
</div>
<div class="sect2">
<h3 id="_update_the_os"><a class="anchor" href="#_update_the_os"></a>Update the OS</h3>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">touch /boot/ssh <i class="conum" data-value="1"></i><b>(1)</b>
timedatectl set-timezone "America/Denver" <i class="conum" data-value="2"></i><b>(2)</b>

date -s "$(wget -qSO- --max-redirect=0 google.com 2&gt;&amp;1 | grep Date: | cut -d' ' -f5-8)Z" <i class="conum" data-value="3"></i><b>(3)</b>

apt update
apt -y upgrade
apt -y install vim
apt -y autoremove
apt -y autoclean

vim /etc/default/keyboard <i class="conum" data-value="4"></i><b>(4)</b>

passwd pi <i class="conum" data-value="5"></i><b>(5)</b>
usermod -aG sudo pi

vim /home/pi/.ssh/authorized_keys <i class="conum" data-value="6"></i><b>(6)</b>

reboot</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Make sure SSH stays enabled</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Set the timezone to the appropriate timezone for yourself</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>This command updates the default time</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Change <code>XKBLAYOUT</code> to <code>us</code></td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>Change the default password to whatever password you want</td>
</tr>
<tr>
<td><i class="conum" data-value="6"></i><b>6</b></td>
<td>Copy any public ssh keys into this folder so that they can log into the pi without the password</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="_docker"><a class="anchor" href="#_docker"></a>Docker</h3>
<div class="paragraph">
<p>First, install the docker engine.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">curl -fsSL https://get.docker.com | sh
usermod -aG docker pi

systemctl enable docker
reboot</code></pre>
</div>
</div>
<div class="paragraph">
<p>Then install docker-compose using pip.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">apt update
apt -y install python3 python3-pip libffi-dev
pip3 install docker-compose

reboot</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_other_programs"><a class="anchor" href="#_other_programs"></a>Other programs</h3>
<div class="paragraph">
<p>We are currently using salt to manage our Pi&#8217;s. We will install salt as well as the programs required to get the UI started.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">wget -O - https://repo.saltstack.com/apt/debian/9/armhf/archive/2018.3.2/SALTSTACK-GPG-KEY.pub | sudo apt-key add -
echo "deb http://repo.saltstack.com/apt/debian/9/armhf/archive/2018.3.2 stretch main" &gt; /etc/apt/sources.list.d/saltstack.list

apt update
apt install -y xserver-xorg xinit i3 chromium-browser tmux imagemagick x11-apps dnsmasq salt-minion ntpdate htop
apt -y upgrade
apt -y autoremove
apt -y autoclean

reboot</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_pi_setup_service"><a class="anchor" href="#_pi_setup_service"></a>Pi Setup Service</h3>
<div class="paragraph">
<p>We have <a href="https://github.com/byuoitav/flight-deck/tree/master/champagne">a service</a> to help provision new Pi&#8217;s. This service that we enable in the image pulls that service down and starts it.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">mkdir /byu
curl https://raw.githubusercontent.com/byuoitav/flight-deck/master/image/pi-setup.service &gt; /byu/pi-setup.service
curl https://raw.githubusercontent.com/byuoitav/flight-deck/master/image/pi-setup.sh &gt; /byu/pi-setup.sh
chmod +x /byu/pi-setup.sh

systemctl daemon-reload
systemctl enable /byu/pi-setup.service</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_final_steps"><a class="anchor" href="#_final_steps"></a>Final steps</h3>
<div class="paragraph">
<p>To keep the image as small as possible, clear the commmand history.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">history -c
shutdown -h now</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_create_a_new_image"><a class="anchor" href="#_create_a_new_image"></a>Create a new image</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Now that we have an SD card with the OS in the state we want it, we need to create an image based on that state. To start, plug the SD card into your computer.</p>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
Copying the image from an SD card will require the same amount of storage as the <em>size</em> of the SD card. For example, a 32GB SD card will require at least 32GB of free space.
</td>
</tr>
</table>
</div>
<div class="sect2">
<h3 id="_take_the_image"><a class="anchor" href="#_take_the_image"></a>Take the image</h3>
<div class="paragraph">
<p>Once the SD card is plugged into your computer, use <code>lsblk</code> to figure out where the SD card is mounted.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">sudo dd if=/dev/sdb of=/path/to/clone.img <i class="conum" data-value="1"></i><b>(1)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Replace <code>/dev/sdb</code> with the mount location of the SD card, and the <code>of=</code> to the location you want the image to go</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="_shrink_image"><a class="anchor" href="#_shrink_image"></a>Shrink image</h3>
<div class="paragraph">
<p>Right now, the image matches the size of the SD card; A lot of that space is wasted. <a href="https://github.com/Drewsif/PiShrink">Pi Shrink</a> is a script that will cut out that useless space.</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
Always be careful downloading and running scripts, especially as sudo.
</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">curl https://raw.githubusercontent.com/Drewsif/PiShrink/master/pishrink.sh &gt; pishrink.sh
chmod +x pishrink.sh
sudo ./pishrink.sh /path/to/clone.img /path/to/shrunk-image.img <i class="conum" data-value="1"></i><b>(1)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Replace <code>/path/to/</code> with the appropriate locations</td>
</tr>
</table>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p>If you need to make small changes to the image <em>after</em> you have already taken it:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Get the start blocks with <code>fdisk -l /path/to/shrunk-image.img</code>. The output will look like:</p>
<div class="literalblock">
<div class="content">
<pre>Disk byuav-2019-08-21.img: 3.56 GiB, 3809141248 bytes, 7439729 sectors
Units: sectors of 1 * 512 = 512 bytes
Sector size (logical/physical): 512 bytes / 512 bytes
I/O size (minimum/optimal): 512 bytes / 512 bytes
Disklabel type: dos
Disk identifier: 0xfd9cf439

Device                Boot  Start     End Sectors  Size Id Type
byuav-2019-08-21.img1        8192  532480  524289  256M  c W95 FAT32 (LBA)
byuav-2019-08-21.img2      540672 7439728 6899057  3.3G 83 Linux</pre>
</div>
</div>
</li>
<li>
<p>Create directories in <code>/mnt</code> to mount each block to (i.e., <code>mkdir /mnt/piroot</code>)</p>
</li>
<li>
<p>Mount the block(s) you want to modify, using the start sector from above. In this case, to mount the second block to <code>/mnt/piroot</code>, I would use this command:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">mount -v -o offset=$((512*540672)) -t ext4 byuav-2019-08-21.img `/mnt/piroot`</code></pre>
</div>
</div>
</li>
<li>
<p>Modify the images files however you need by adding/modifying/deleting files from <code>/mnt/piroot</code></p>
</li>
<li>
<p>Unmount the block(s)</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">umount /mnt/piroot</code></pre>
</div>
</div>
</li>
</ol>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="_compress_image"><a class="anchor" href="#_compress_image"></a>Compress image</h3>
<div class="paragraph">
<p>To have the smallest image size, use gzip to compress the shrunk image before sharing it.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">gzip -k -9 /path/to/shrunk-image.img</code></pre>
</div>
</div>
</div>
</div>
</div>
</article>
</main>
</div>
<footer class="footer">
  <p>Copyright (C) 2019-2020 <a href="https://byu.edu">Brigham Young University</a>.</p>
  <p>Except where otherwise noted, docs.av.byu.edu are licensed under the <a href="https://www.mozilla.org/en-US/MPL/2.0/">Apache Version 2.0</a></p>
</footer>
<script src="../_/js/site.js"></script>
<script async src="../_/js/vendor/highlight.js"></script>
  </body>
</html>
